# CLAUDE.md ‚Äî cstore

> Context file for AI assistants working on this project.

---

## Project Overview

**cstore** is a pnpm-inspired global store for Composer packages.  
Instead of each PHP project having its own full `vendor/` directory, cstore stores packages once in `~/.composer-store` and hard links them into each project's `vendor/`.

**Elevator pitch:** pnpm did this for Node.js. cstore does it for PHP/Composer.

---

## Core Concept

```
Without cstore:
  project-a/vendor/laravel/framework/  ‚Üê full copy (20MB)
  project-b/vendor/laravel/framework/  ‚Üê full copy (20MB)  [DUPLICATE]
  project-c/vendor/laravel/framework/  ‚Üê full copy (20MB)  [DUPLICATE]

With cstore:
  ~/.composer-store/packages/laravel+framework@11.0.0/  ‚Üê stored ONCE (20MB)
  project-a/vendor/laravel/framework/  ‚Üê hard link (0MB extra)
  project-b/vendor/laravel/framework/  ‚Üê hard link (0MB extra)
  project-c/vendor/laravel/framework/  ‚Üê hard link (0MB extra)
```

**Key insight:** `vendor/composer/` (autoloader files) is ALWAYS per-project and never shared. Only the package source files are linked from the store.

---

## Architecture

### Directory Structure

```
~/.composer-store/
  packages/
    laravel+framework@11.0.0/     ‚Üê package key format: vendor+name@version
      src/
      composer.json
      .cstore-complete             ‚Üê marker: download was complete (not partial)
    filament+filament@3.2.0/
  metadata/
    index.json                    ‚Üê future: registry cache

project/vendor/
  laravel/
    framework/
      .cstore-link                ‚Üê marker: points to store path (for prune scanning)
      src/                        ‚Üê hard linked files from store
  composer/                       ‚Üê NEVER managed by cstore, always per-project
    autoload_classmap.php
    autoload_psr4.php
    ...
  autoload.php                    ‚Üê per-project
```

### Source Layout

```
bin/
  cstore                          ‚Üê CLI entry point (PHP script)
src/
  Application.php                 ‚Üê Symfony Console bootstrap, registers all commands
  Commands/
    InstallCommand.php            ‚Üê `cstore install` ‚Äî main workflow
    StatusCommand.php             ‚Üê `cstore status` ‚Äî store stats
    PruneCommand.php              ‚Üê `cstore prune` ‚Äî remove unused packages
  Store/
    GlobalStore.php               ‚Üê manages ~/.composer-store directory
    PackageDownloader.php         ‚Üê downloads packages from dist URLs into store
  Linker/
    VendorLinker.php              ‚Üê hard links store packages into project vendor/
    AutoloaderGenerator.php       ‚Üê shells out to `composer dump-autoload`
  Parser/
    LockFileParser.php            ‚Üê parses composer.lock, extracts package metadata
tests/
  (PHPUnit tests ‚Äî Phase 3)
```

---

## Key Design Decisions

### Hard Links over Symlinks
- Hard links don't break `__DIR__` or `realpath()` in PHP (symlinks can)
- Hard links survive if store is moved (symlinks would break)
- Fallback: if hard link fails (cross-filesystem), fall back to `copy()`

### Package Key Format
- Format: `vendor+name@version` (e.g. `laravel+framework@11.0.0`)
- Uses `+` instead of `/` to avoid nested directories in the store
- Stored under `~/.composer-store/packages/`

### Completion Markers
- `.cstore-complete` written after successful download ‚Äî prevents partial downloads being used
- `.cstore-link` written in `vendor/pkg/` ‚Äî contains store path, used by `prune --scan`

### Autoloader Strategy (Phase 1)
- Shells out to `composer dump-autoload` after linking
- This is intentional ‚Äî reimplementing Composer's autoload generation is complex
- Phase 2 will integrate as a Composer Plugin, making this native

### What is NOT stored in the global store
- `vendor/composer/` directory (per-project autoloader maps)
- Files generated by post-install scripts
- Native PHP extensions (`.so`, `.dll`)

---

## Commands

### `cstore install [path] [--no-dev] [--store=PATH]`
Main workflow:
1. Read `composer.lock` from project path
2. For each package: check if in store ‚Üí sync if not (`zip`/`tar`/`tgz`/`path`) ‚Üí hard link into `vendor/`
3. Run `composer dump-autoload` to regenerate autoloader

### `cstore status [--store=PATH]`
Shows store location, total packages, total disk usage, and lists all stored packages.

### `cstore prune [--dry-run] [--scan=DIR]... [--store=PATH]`
Removes packages from store not referenced by any project.
- Without `--scan`: lists all packages (manual review)
- With `--scan ~/projects`: scans for `.cstore-link` markers to find active references

---

## Development Phases

| Phase | Status | Goal |
|-------|--------|------|
| 1 | ‚úÖ Complete | CLI MVP ‚Äî `install`, `status`, `prune` |
| 2 | ‚úÖ Complete | Composer Plugin ‚Äî transparent `composer install` integration |
| 3 | ‚úÖ Complete | Edge cases ‚Äî post-install scripts, integrity checks, PHPUnit suite |
| 4 | üî≤ Planned | Windows support, Packagist release, parallel downloads |

---

## Composer Plugin (Current)

The plugin is implemented with a custom `LibraryInstaller`:

```php
// composer.json of any project
{
  "require": {
    "cstore/cstore": "^1.0"
  }
}
```

- Library packages are intercepted by `CStoreInstaller`
- Supported dist types are stored via cstore (`zip`, `tar`, `tgz`/`tar.gz`, `path`)
- Unsupported/source-only packages gracefully fall back to Composer's default installer
- Composer continues to generate the autoloader in-process

---

## Known Limitations

- Source-only VCS installs (no dist archive URL) fall back to Composer default
- Packages with `scripts` in their `composer.json` are copied, not hard-linked
- Windows not supported (no hard links via `link()`) ‚Äî Phase 4
- No parallel downloads ‚Äî packages downloaded sequentially

---

## Tech Stack

| Component | Choice | Reason |
|-----------|--------|--------|
| Language | PHP 8.1+ | Same ecosystem as Composer |
| CLI framework | symfony/console | Already a Composer dependency, battle-tested |
| Testing | PHPUnit 10+ | PHP standard |
| Min PHP | 8.1 | Enums, fibers, intersection types available if needed |

---

## Running Locally

```bash
# Install dependencies
composer install

# Run against a project
./bin/cstore install /path/to/laravel-project

# Check what's in the store
./bin/cstore status

# Prune packages not used by any project in ~/projects
./bin/cstore prune --scan ~/projects --dry-run
```

---

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `CSTORE_PATH` | `~/.composer-store` | Override global store location |

*(Not yet implemented)*

---

## Contributing

- PSR-12 coding style
- All new features need PHPUnit tests (Phase 3+)
- PRs should include a `CHANGELOG` entry
